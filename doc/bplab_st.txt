1. Описание прибора BP005.
2. Общее описание функционирования прибора
Прибор BP005 представляет собой носимый регистратор, предназначенный для сбора данных об артериальном давлении (АД), частоте пульса и иных параметрах пациента в ходе 24-часового амбулаторного мониторирования, с последующим переносом этих данных в персональный компьютер.

Возможные сочетания аппаратных возможностей прибора и параметров, регистрируемых в различных режимах, сведены в таблицу:
[здесь будет таблица]

3. Распределение памяти.
4. Распределение памяти данных процессора.
On-chip memory
Блок B2  0060h - 007Fh
Блок B0  0200h - 02FFh
Блок B1  0300h - 03FFh
Блок B3  0800h - 17FFh

External memory.
Адресное пространство 1800h - 0FFFFh.
Фактически используемый диапазон адресов 8000h..0FFFFh -  32 кбайт область памяти обращения к Flash.

Адреса Flash с А15 по А20 образуют номер страницы, являются выходом буферного регистра и соответствуют разрядам шины данных D6- D11. Сами Flash образуют папки. В папке с номером "0" хранятся данные, связанные с давлением, а в папках с 1 по 7 - данные ЭКГ.
5. Распределение Flash памяти данных давления.
Адреса
Описание данных
00000h - 001FFh
Таблица начальных адресов процессов измерений
00200h - 002FFh
Параметры программирования прибора (п. )
00300h - 007FFh
Промежуточные результаты измерений
00800h - 00FFFh
Таблица результатов "плановых" измерений
01000h - XXXXXh
Таблица результатов "минутных" измерений (если она есть)
XXXXXh - 1FFFFFh
Процессы измерений (если нет таблицы результатов "минутных" измерений, то начинается с 01000h)
6. Параметры программирования прибора.

Формат параметров программирования описан в п.2.2. Если прибор не был инициализирован, то область параметров программирования прибора заполнена кодом FFh. Это свойство может использоваться для проверки инициализации прибора.
7. Таблица результатов измерения.

Максимальное количество измерений  - 255. Соответственно, таблица содержит 255 записей (формат описан в п.2.3.). Записи, соответствующие несуществующим измерениям, заполнены кодом FFh.
8. Таблица начальных адресов процессов измерений.

Таблица содержит 256 элементов, первые 255 из которых соответствуют строкам с соответствующими номерами из таблицы результатов измерений.
Каждый элемент таблицы представляет собой 16-разрядное слово (первый байт каждой пары младший), описывающее 21-разрядный адрес во flash памяти. Младшие биты адреса предполагаются равными нулю. Истинное значение адреса получается путем умножения слова из таблицы на 25.
Размещение каждого процесса измерения во flash памяти описывается двумя адресами - начальным и конечным, причем конечный адрес очередного процесса измерения (за исключением последнего) является начальным адресом следующего за ним процесса измерения. Последний, 256-й элемент таблицы предназначен для записи конечного адреса последнего, 255-го процесса измерения. Последовательность адресов является неубывающей. Появление двух следующих друг за другом одинаковых адресов означает, что соответствующий процесс измерения имеет нулевую длину.
Элементы таблицы со значением FFFFh не соответствуют реальным физическим адресам. Элемент, предшествующий первому элементу со значением FFFFh, описывает конечный адрес последнего записанного процесса измерения. Это свойство может использоваться для определения общего количества измерений.
9. Процессы измерений.
Процесс измерения представляет собой запись данных одного или нескольких сигналов, регистрируемых в процессе измерения давления, и имеет максимальную продолжительность во времени около 2 минут. Сигналы могут представлять собой значения давления в манжете, напряжения на выходе микрофона, напряжения ЭКГ сигнала и т.д. Данные разных сигналов, полученные в каждый отдельный момент времени, группируются в памяти вместе (находятся в смежных байтах). Фактическое описание формата процесса измерения содержится в сигнатуре прибора. При выводе процесса измерения из прибора данным сигналов предшествует массив данных разметки (см. п.2.4.).
10. Распределение Flash памяти данных ЭКГ.
[хранятся данные ЭКГ, записанные (в отличие от процессов измерения) за полное время мониторирования, формат записи разрабатывается]

11. Форматы данных
12. Формат сигнатуры:
Сигнатура представляет собор описание прибора и структуры его данных.


Поле
Размер поля, байт
Описание данных
Примечание


1
степень двойки в числе, означающем количество байт в кластере


Служебный
1
Если бит 3 (маска 08h) установлен в 1, то это тестовая (сертификационная прошивка)


Серийный номер прибора
4
Array[1..6] Of Byte


Номер версии
5
Array[1..5] Of Char
вида '00.01'

Поддержка хранения таблицы результатов "минутных" измерений
1
0 - нет
0FFh - да
Исключено

Подтверждение Детский/взрослый
1
FFh - режим не подтвержден
5Ah - детский
A5h - взрослый [2001-01-29]
Устанавливается прибором при программировании

Поддержка хранения процессов измерения
1
0 - нет
0FFh - да
Всегда 0FFh

Поддержка хранения непрерывной (24-часовой) записи сигналов
1
0 - нет
0FFh - да


Максимальное количество процессов измерений
2
Word
в текущей версии 255
Раздел описания таблицы результатов "минутных" измерений

Сжатие хранимых данных
1
0 - нет
1 - метод 1


Максимальное количество отсчетов в процессе измерения
2
Word
не более 32764

Частота дискретизации
2
Word (отсчет / час)


Фактическое количество массивов в процессе измерения
1
Byte
не более 8

Таблица описания сигналов
64
Array [1..8] Of TSampleDef

Раздел описания процессов измерений

Сжатие хранимых данных
1
0 - нет
1 - метод 1


Максимальное количество отсчетов в процессе измерения
2
Word
не более 32764

Частота дискретизации
2
Word (отсчет / сек)


Фактическое количество массивов в процессе измерения
1
Byte
не более 8

Таблица описания сигналов
64
Array [1..8] Of TSampleDef

Раздел описания непрерывных записей сигналов

Сжатие хранимых данных
1
0 - нет
1 - метод 1


Максимальное количество отсчетов в процессе измерения
2
Word
фиктивный параметр (для единообразия)

Частота дискретизации
2
Word (отсчет / сек)


Фактическое количество массивов в процессе измерения
1
Byte
не более 8

Таблица описания сигналов
64
Array [1..8] Of TSampleDef


Формат одного элемента таблицы описания сигналов (TSampleDef)
1-й байт - тип данных (1 - Word, 2 - Integer, 3 - Byte, 4 - ShortInt)
2-й байт - источник сигнала (0 - давление в манжете, 1 - ЭКГ, 2 - сигнал с микрофона)
3 и 4-й байт (Integer) - значение полной шкалы (наибольшего положительного значения) для используемого типа данных, в принятых физ. единицах (для давления - мм рт.ст.)
5 и 6-й байт (Integer) - минимально возможное значение (может иметь произвольный знак) сигнала, в принятых физ. единицах
7 и 8-й байт (Integer) - значение базового уровня сигнала (к которому надо прибавлять значения элементов массива), в принятых физ. единицах

13. Параметры программирования прибора:

Поле
Размер поля, байт
Описание данных
Примечание

Идентификатор пациента
8
Array[1..8] Of Char


Фамилия И.О.
16
Array[1..16] Of Char

1. 
Возраст (лет)
1
Беззнаковое целое число
Менее 14  лет - считается ребенком

Резерв
3



Дата инициализации (число, месяц, год)
4
1-й байт - число (1..31)
2-й байт - месяц (1..12)
3 и 4-й байты - год


Время инициализации (минуты, часы)
4
1-й байт - минуты, единицы
2-й байт - минуты, десятки
3-й байт - часы, единицы
4-й байт - часы, десятки


Начало дневного времени (часы)
2
1-й байт - часы, единицы
2-й байт - часы, десятки


Окончание дневного времени (часы)
2
1-й байт - часы, единицы
2-й байт - часы, десятки


Начало "специального" времени (часы)
2
1-й байт - часы, единицы
2-й байт - часы, десятки


Окончание "специального" времени (часы)
2
1-й байт - часы, единицы
2-й байт - часы, десятки


Интервал между измерениями днем
2
1-й байт - минуты, единицы
2-й байт - минуты, десятки
Max. 99 минут

Интервал между измерениями ночью
2
1-й байт - минуты, единицы
2-й байт - минуты, десятки
Max. 99 минут

Интервал между измерениями в "спец." время
2
1-й байт - минуты, единицы
2-й байт - минуты, десятки
Max. 99 минут

Признаки
1
1 байт (набор битовых флагов):
0-й бит - разрешение звукового сигнала
1-й бит - разрешение индикации результатов
2-й бит - разрешение на удлиненный период предварительного анализа пульсаций давления
3-й бит - разрешение режима прогноза давления в ночное время

1. 1. 1. 1. 1. 1. 
Порог изменения результатов измерения
1
Величина относительного изменения (в процентах) одного из измеренных значений давления или ЧСС по сравнению с усредненной величиной за 4 предыдущих измерения, при превышении которой проводится повторное измерение


Максимальное давление в манжете
1
Величина давления в манжете, которую нельзя превышать для данного пациента, значение соответствует истинному минус 48 (мм.рт.ст.)
Рекомендуемые значения:
Для детей - (190 - 48)
Для взрослых (290 - 48)
Диапазон от 48 до 300

Детский/взрослый
1
5Ah - детский
A5h - взрослый


Резерв
?
00h в количестве, дополняющем данные программирования до 256 байт.


14. Формат одной записи результатов измерений


Поле
Размер поля, байт
Описание данных
Примечание

Время начала измерения
3
Байт 1:
0-5 разряды - секунды,
6 разряд - признак ручного измерения
7 разряд - резерв
Байт 2:
0-3 разряды - единицы минут,
4-7 разряды - десятки минут,
Байт 3:
0-3 разряды - единицы часов,
4-7 разряды - десятки часов


Систолическое давление
1
истинное значение минус 48 (мм.рт.ст.)
Диапазон измерения от 48 до 300

Среднее давление
1
истинное значение минус 48 (мм.рт.ст.)
Диапазон измерения от 48 до 300

Диастолическое давление
1
(мм.рт.ст.)
Диапазон измерения от 0 до 255

Частота сердечных сокращений
1
(уд/мин)
Диапазон измерения от 0 до 255

Код ошибки
1
См. раздел "Обработка ошибок и сбоев"


15. Данные разметки процесса измерения

Разметка создается в регистраторе в процессе вычисления результатов измерения. Данные разметки содержат 3 массива:
1. Массив описания режимов (ступеней) измерения содержит значения адресов старта и финиша, среднее давление, средний максимум (4 слова на ступеньку, макс. 32 ступеньки);
2. Массив адресов (номеров отсчетов, начиная с 0) максимумов, до 512 слов;
3. Массив адресов (номеров отсчетов, начиная с 0) R-зубцов, до 512 слов;

Во флэш-памяти регистратора BP005 приборная разметка записываются непосредственно перед данными сигнала следующего измерения в следующем порядке:
1. Массив описания ступеней (переменной длины, кратной 4 словам, до 256 байт);
2. Массив адресов максимумов (переменной длины, кратной слову, до 512 байт);
3. Массив диагностической информации (переменной длины, кратной 128 байт, до 128*127 байт);
4. Массив адресов R-зубцов (переменной длины, кратной слову, до 1024 байт)
1. Фактическая длина (число 8-байтных элементов)5.  массива описания ступеней (одно слово);
6. Фактическая длина (число 2-байтных элементов) массива адресов максимумов (одно слово);
7. Фактическая длина (число 128-байтных элементов) массива диагностической информации и фактическая длина (число 2-байтных элементов) массива адресов R-зубцов (одно слово, в котором разряды 0..8 определяют длину массива R-зубцов, а разряды 9..15 - длину массива диагностической информации).

16. Протоколы обмена между BP005 и PC
17. Взгляд на обмен сверху.
В основу обмена положены следующие принципы:
Скорость обмена выбирается из ряда 9,6/19,2/38,4/57,2 Кбит/с. Слово содержит 8 информационных бит, один стоп бит. Проверка на четность не используется. Большая скорость (до 1-го Мбита/с) используется только при считывании  "результатов ЭКГ" и реализуется через специальный интерфейс.
Обмен начинается на любой (из ряда) скорости посылкой символа "А", необходимого для определения скорости обмена прибором. При отсутствии ответа ("A" , Ok) в течении 0.1с, повторить попытку (до 4-х раз). Далее понижения скорость обмена и повторить попытку. При отсутствии ответа выдать сообщение "Нет связи с монитором ". При наличии ответа, проводится проверка помехоустойчивости - (проба скорости) - посылается 256 байт символов "A", "U". При отсутствии ошибок в ответ посылается  "A", "U".  При наличии ошибок скорость понижается, для этого надо выдержать время не менее 0.5 секунды и начать процедуру с начала на меньшей скорости.   
Инициатором любого обмена всегда является PC. Прибор только выполняет команды.
Все команды содержат 4-а байта. Структура команды описана ниже.
Все команды выполняются после второго получения команды с промежуточным подтверждением, т.е. возвратом кода команды в PC.
Если в команде два первых слова не совпали или команды нет в списке, то возвращается код ошибки.
При ошибке, PC пробует повторить запрос - до 4-х раз, потом понижает скорость (но не менее чем 9.6 Кбит/с) и при  повторении ошибок или отсутствия ответа принимает решение об отсутствии связи  с прибором.
Данные, как правило, передаются блоками по 2 Кбайт (оговаривается в конкретных протоколах). В конце блока передается "контрольная сумма" (4-е байта, первый байт младший). Контрольная сумма считается по формуле:

Crc(32bit) = CrcTab ((Crc XOR Byte) AND 000000FFh) XOR (Crc SHR8bit)

Начальное значение Crc=FFFFFFFFh

Список и коды команд и ответов приведены в таблице 2.

Таблица 2
N
Описание команды или ответа
Код команды
1
Запрограммировать BP005
00010001b (11h)
2
Считать сигнатуру
00100010b (22h)
3
Считать данные из Flash давления
00110011b (33h)
4
Очистить Flash давления
01000100b (44h)
5
Проба (тест) скорости
01010101b (55h)
6
Зарезервировано
01100110b (66h)
7
Зарезервировано
01110111b (77h)
8
Считать результаты ЭКГ
10001000b (88h)
9
Очистить Flash ЭКГ
10011001b (99h)
10
Зарезервировано
10101010b (AAh)
11
Записать блок данных в прибор
10111011b (BBh)
12
Служебная команда
11001100b (CCh)
13
Зарезервировано
11011101b (DDh)
14
Зарезервировано
11101110b (EEh)
15
Ошибка
11111111b (FFh)
16
Ok (Завершение обмена)
00000000b (00h)
18. Определение скорости обмена (55h).
N
Направление обмена
Структура посылки
Примечание
1
PC > BP
41h
См. раздел 2.1
2
PC < BP
41h,00h

3
PC > BP
55h,55h,55h,55h

4
PC < BP
Варианты ответа:
55h,55h,55h,55h {эхо}
FFh,FFh,FFh,FFh {ошибка связи}

5
PC > BP
55h,55h,55h,55h, 41h,55h,41h,55h,...,41h,55h
Команда + 256 байт (чередующиеся "A", "U")
6
PC < BP
Варианты ответа:
55h,55h,55h,55h, 41h,55h,...,41h,55h {эхо}
FFh,FFh,FFh,FFh {ошибка связи}


19. Программирование BP005 (11h).

Направление обмена
Структура посылки
Примечание

PC > BP
11h,11h,11h,11h.


PC < BP
Варианты ответа:
11h,11h,11h,11h {эхо}
FFh,FFh,FFh,FFh {ошибка связи}
При ошибке - стандартная процедура с повторами

PC > BP
11h,11h,11h,11h, xxh,...xxh,Crh(мл)...,Crh(ст.).
Где:
xxh - массив параметров (256 байт) согласно п.2.2.
Crh - контрольная сумма (4 байта)

PC < BP
Варианты ответа:
11h,11h,00h,00h {команда выполнена, прибор запрограммирован  на взрослый режим}
11h,11h,66h,66h {команда выполнена, прибор запрограммирован  на детский режим}
11h,11h,AAh,AAh {команда не может быть выполнена из-за запрещенного сочетания параметров программирования)
11h,11h,FFh,FFh {команда не выполнена из-за аппаратного сбоя)
FFh,FFh,FFh,FFh {ошибка связи}

20. Считывание сигнатуры (22h).

Направление обмена
Структура посылки
Примечание

PC > BP
22h,22h,22h,22h,.


PC < BP
Варианты ответа:
22h,22h,22h,22h {эхо}
FFh,FFh,FFh,FFh {ошибка связи}
При ошибке - стандартная процедура с повторами

PC > BP
22h,22h,22h,22h


PC < BP
Варианты ответа:
22h,22h,22h,22h.,xxh(мл),... xxh(ст.), Crh(мл),...Crh(ст.)
FFh,FFh,FFh,FFh. {ошибка связи}
Где:
xxh - массив сигнатуры
Crh - "контрольная сумма" массива (4-е байта).

1. 
21. Считывание данных из Flash давления (33h).

Направление обмена
Структура посылки
Примечание

PC > BP
33h,33h,NNh(мл),NNhh(ст).
NN - номер блока данных (определяет начальные адреса с дискретностью 32 байта)

PC < BP
Варианты ответа:
33h,33h,NNh(мл),NNhh(ст). {эхо}
FFh,FFh,FFh,FFh. {ошибка связи}
При ошибке - стандартная процедура с повторами

PC > BP
33h,33h,NNh(мл),NNhh(ст).


PC < BP
Варианты ответа:
33h,33h,NNh(мл),NNhh(ст), xxh(мл),... xxh(ст.), Crh(мл),...Crh(ст.)
FFh,FFh,FFh,FFh {ошибка связи}
Где:
xxh - массив данных (2048 байт)
Crh - контрольная сумма (4 байта)

22. Считывание данных из Flash программ AVR (DDh).

Направление обмена
Структура посылки
Примечание

PC > BP
DDh,DDh,NNh(мл),NNhh(ст).
NN - номер блока данных (определяет начальные адреса с дискретностью 32 байта)

PC < BP
Варианты ответа:
DDh,DDh,NNh(мл),NNhh(ст). {эхо}
FFh,FFh,FFh,FFh. {ошибка связи}
При ошибке - стандартная процедура с повторами

PC > BP
DDh,DDh,NNh(мл),NNhh(ст).


PC < BP
Варианты ответа:
DDh,DDh,NNh(мл),NNhh(ст), xxh(мл),... xxh(ст.), Crh(мл),...Crh(ст.)
FFh,FFh,FFh,FFh {ошибка связи}
Где:
xxh - массив данных (2048 байт)
Crh - контрольная сумма (4 байта)
23. Считывание результатов ЭКГ (88h).

Направление обмена
Структура посылки
Примечание

PC > BP
88h,88h, NNh(мл),NNhh(ст)
NN - номер блока данных (определяет начальные адреса с дискретностью 256 байта)

PC < BP
Варианты ответа:
88h,88h, NNh(мл),NNhh(ст) {эхо}
FFh,FFh,FFh,FFh {ошибка связи}
При ошибке - стандартная процедура с повторами

PC > BP
88h,88h, NNh(мл),NNhh(ст)


PC < BP
Варианты ответа:
88h,88h,NNh(мл),NNhh(ст), xxh(мл),... xxh(ст.), Crh(мл),...Crh(ст.)
FFh,FFh,FFh,FFh.
Где:
xxh - массив данных (2048 байт)
Crh - контрольная сумма (4 байта)
24. Очистка Flash давления (44h).

Направление обмена
Структура посылки
Примечание

PC > BP
44h,44h,44h,44h.


PC < BP
Варианты ответа:
44h,44h,44h,44h. {эхо}/
FFh,FFh,FFh,FFh {ошибка связи}
При ошибке - стандартная процедура с повторами

PC > BP
44h,44h,44h,44h..


PC < BP
Варианты ответа:
44h,44h,00h,00h {команда выполнена}
44h,44h,FFh,FFh {команда не выполнена}
FFh,FFh,FFh,FFh. {ошибка связи}
При успешном выполнении ответ приходит по завершении очистки (через 1-15с.)

25. Очистка Flash ЭКГ (99h).

Направление обмена
Структура посылки
Примечание

PC > BP
99h,99h,99h,99h.


PC < BP
Варианты ответа:
99h,99h,99h,99h {эхо}
FFh,FFh,FFh,FFh {ошибка связи}
При ошибке - стандартная процедура с повторами

PC > BP
99h,99h,99h,99h.


PC < BP
Варианты ответа:
99h,99h,00h,00h {команда выполнена}
99h,99h,FFh,FFh {команда не выполнена}
FFh,FFh,FFh,FFh. {ошибка связи}
При успешном выполнении ответ приходит по завершении очистки (через 5-180с.)

26. Записать блок данных в прибор (BBh).

Направление обмена
Структура посылки
Примечание

PC > BP
BBh,BBh,NNh(мл),NNhh(ст)
NN- номер блока

PC < BP
Варианты ответа:
BBh,BBh,NNh(мл),NNhh(ст) {эхо}
FFh,FFh,FFh,FFh {ошибка связи}
При ошибке - стандартная процедура с повторами

PC > BP
BBh,BBh,NNh(мл),NNhh(ст)., xxh,...xxh,Crh(мл)...,Crh(ст.).
Где:
xxh - массив данных (2048 байт) 
Crh - контрольная сумма (4 байта).

PC < BP
Варианты ответа:
BBh,BBh,00h,00h {команда выполнена}
BBh,BBh,FFh,FFh {команда не выполнена из-за аппаратного сбоя}
FFh,FFh,FFh,FFh. {ошибка связи}


27. Служебная команда (CCh).

Направление обмена
Структура посылки
Примечание

PC > BP
CCh,CCh,NNh(мл),NNhh(ст)
NN - номер пофункции

PC < BP
Варианты ответа:
CCh,CCh,NNh(мл),NNhh(ст) {эхо}
FFh,FFh,FFh,FFh {ошибка связи}
При ошибке - стандартная процедура с повторами

PC > BP
CCh, CCh,NNh(мл),NNhh(ст)., xxh,...xxh, Crh(мл)...,Crh(ст.).
Где:
xxh - массив параметров (длина зависит от подфункции)
Crh - контрольная сумма (4 байта)

PC < BP
Варианты ответа:
CCh,CCh,00h,00h {команда выполнена}
CCh,CCh,AAh,AAh {команда не может быть выполнена, т.к. неверно задан номер или параметры подфункции}
CCh,CCh,FFh,FFh {команда не выполнена из-за аппаратного сбоя }
FFh,FFh,FFh,FFh. {ошибка связи}
При успешном выполнении ответ приходит по завершении отработки команды


Подфункции служебной команды:
┌──────────┬──────────────────────┬──────────┬─────────────────────────────────────────    
│Номер (NN)│   Название подфункции│  Длина   │  Формат       Время       Примечание    
│          │                      │ массива  │  строки      отработки     
│          │                      │параметров│ параметров   команды    
│          │                      │ (байт)   │
├──────────┼──────────────────────┼──────────┼─────                
│0101h     │Проконтролировать     │    0     │                5-25 с    
│          │Flash давления        │          │
│0202h     │Проконтролировать     │    0     │                5-180 с    
│          │Flash ЭКГ             │          │
│0303h     │Разрешить             │    8     │  Array[1..8]     
│          │модификацию памяти    │          │   Of Char    
│          │прибора               │          │
│0404h     │Переписать область    │    0     │                5-10 с     Из последних     
│          │flash памяти данных   │          │                             64_кбайт 0-й страницы     
│          │в память программ     │          │                             flash памяти данных    
│          │рабочего процессора   │          │
│          │(TMS)                 │          │
│0505h     │Переписать область    │    0     │                5-10 с     Из последних 64_кбайт 0-й страницы flash памяти данных    
│          │flash памяти данных   │          │
│          │в память программ     │          │
│          │защитного процессора  │          │
│          │(AVR)                 │          │
│0606h     │Стереть данные в      │    0     │                <3 с    
│          │памяти программ AVR   │          │
│0707h     │Перейти в поверочный  │    0     │
│          │режим 0 (запустить    │          │
│          │тестовый режим часов) │          │
│0808h     │Считывание аварийного │          │                           Возвращается массив длиной 2048 байт, байт 0 - код аварийного процессора    
│          │кода процессора AVR   │          │
│0909h     │Считывание версии     │          │                           Возвращается массив длиной 2048 байт, с нулевого смещения следует строка, заканчивающаяся 0    
│          │прошивки TMS          │          │
│0A0Ah     │Закрыть память        │          │
│          │программ AVR          │          │
│          │                      │          │
│0B0Bh     │Считывание версии     │          │                           Возвращается массив длиной 2048 байт, с нулевого смещения следует строка, заканчивающаяся 0    
│          │прошивки AVR          │          │ 
│?         │Перейти в поверочный  │     0    │ 
│          │режим 1               │          │ 
│?         │Перейти в поверочный  │     0    │ 
│          │режим 2               │          │ 
│1010h     │Установить интервал   │     2    │              Word         Одна единица соответствует 5 мс. Минимальное значение 40 (200 мс)    
│          │таймаута              │          │ 
├──────────┴──────────────────────┴──────────┼─────────                                               
│                                            │

Аварийные коды процессора AVR:
EEh - Ok
00h - превышение 2 минут
01h - давление превысило 295 мм рт.ст.
02h - давление превысило 320 мм рт.ст.
04h - напряжение на аналоговой части держалось > 1 минуты без проведения измерения



28. Протокол перепрограммирования Flash памяти программ TMS

Процедура перепрограммирования прибора состоит из следующих шагов:
Проверить существование и корректность файла прошивки
Разрешить модификацию данных прибора (служебная команда)
Проверить область flash памяти давления в диапазоне адресов 1F0000h..1FFFFFh (последние 64 кбайт) на пустоту (т.е. что содержит только коды FFh). Если эта область не пуста, то очистить память давления (44,44,44,44)
Переслать в последние 64 кбайт flash давления массив кодов новой версии программы блоками по 2048 байт (PutBlock), пустоты заполняются кодом FFh
Произвести контрольное чтение закачанного массива
Дать прибору команду на перешивку flash программ TMS (служебная команда)
При таймауте считаем, что процесс завершен и пытаемся связаться с прибором и инициализировать его тестовыми данными
[Здесь будет дописан раздел о безопасном перепрограммировании TMS с учетом соответствия прошивки аппаратным особенностям прибора]

29. Протокол перепрограммирования Flash памяти программ AVR

Процедура перепрограммирования прибора состоит из следующих шагов:
Проверить существование и корректность файла прошивки
Разрешить модификацию данных прибора (служебная команда)
Проверить область flash памяти давления в диапазоне адресов 1F0000h..1FFFFFh (последние 64 кбайт ) на пустоту (т.е. что содержит только коды FFh). Если эта область не пуста, то очистить память давления (44,44,44,44)
Переслать в последние 64 кбайт flash давления массив кодов новой версии программы блоками по 2048 байт (PutBlock), пустоты заполняются кодом FFh
Произвести контрольное чтение закачанного массива
Дать прибору команду на перешивку flash программ AVR (служебная команда)
При получении Ok  или Fail считаем, что процесс завершен и пытаемся связаться с прибором и инициализировать его тестовыми данными

30. Алгоритм работы планировщика измерений

Измерения давления могут быть плановыми, внеочередными и повторными.

Плановые измерения проводятся через интервалы времени, заданные при программировании прибора (отдельно для дня, ночи и специального интервала).

Внеочередное измерение производится при нажатии на кнопку СТАРТ/СТОП. После внеочередного измерения очередное плановое измерение производится через интервал времени, заданный в параметрах программирования прибора для соответствующего периода.

Повторное измерение проводится в следующих случаях:
Через 3 минуты после неудачного планового или внеочередного измерения с кодом самодиагностики больше чем <...>
Через 3 минуты после планового или внеочередного измерения, в случае, если хотя бы один из измеренных параметров существенно (на величину, превышающую пороговое значение, заданное в параметрах программирования прибора) отличается от полученного в предыдущем измерении

Нажатие кнопки в процессе проведения измерения приводит к немедленному прекращению процесса измерения и стравливанию воздуха из манжеты. Повторное измерение при этом не производится.

Если в параметрах программирования прибора разрешен режим прогноза давления в ночное время, то в ночное время вместо плановых измерений давления проводится оценка формы пульсовой волны при давлении в манжете 40 мм рт.ст.
Если параметры сигнала существенно отличаются от тех, что были в предыдущем измерении, то производится измерение по полному циклу.
Если параметры сигнала не отличаются от тех, что были в предыдущем измерении, то измерение не проводится. При этом в таблицу результатов измерений помещаются те же значения, что и в предыдущем измерении, а значение кода ошибки устанавливается равным  <20>.
31. Обработка ошибок и сбоев

Коды ошибок, которые во время мониторирования заносятся в таблицу результатов измерений, делятся на следующие классы:
предупреждения, указывающие на то, что результаты измерения в соответствующей строке могут быть использованы для анализа, но их получение было связано с какими-то особыми условиями
события, во время которых фактическое измерение не проводилось
фатальные ошибки измерения, после которых повторное измерение не проводится
нефатальные ошибки измерения, после которых проводится повторное измерение

Таблица кодов ошибок

Код
Код BP3400
Значение
Критерий
Модуль (процедура)
Класс

00
Успешное измерение
Монитор запрограммирован и готов к исследованию, измерение без ошибок


предупреждение


Измерение произведено в режиме прогноза
(резерв на будущее)

предупреждение


Восстановление питания


событие

80
Отмена измерения пациентом


фатальная ошибка

81
Мало напряжение батареи
Либо было прерывание INT0, либо контроль по значению АЦП

фатальная ошибка

82
Отсутствует (отсоединена) манжета
Скорость увеличения давления меньше минимальной
Pr_a_t40.asm
фатальная ошибка

83
Манжета или пневмосистема в мониторе пропускают воздух
Скорость уменьшения давления на 40мм.рт.ст. больше чем 2 мм.рт.ст./сек. (время анализа больше 3)
Pr_a_t40.asm
фатальная ошибка


Не удается накачать нужное давление (Манжета или пневмосистема в мониторе пропускают воздух)
Время увеличения давления больше 30 сек.
Pr_a_t40.asm, Pressaug.asm


84
Пережата трубка манжеты
Скорость увеличения давления больше максимальной.
Pr_a_t40.asm, Pressaug.asm
фатальная ошибка

99
Система не стравливает воздух при открытии клапана

Pr_a_stp.asm, Pr_a_t40.asm, Pr_dimin.asm
Фатальная ошибка

86
Мал уровень пульсации.
Низкий уровень сигнала (его отсутствие)
Амплитуда пульсаций больше 0.3 мм.рт.ст меньше чем на 4-х ступеньках
 Press_m.asm (determination_s_a_d)
нефатальная ошибка

87
Время измерения АД превысило 2 мин


нефатальная ошибка

88, 89
Высокая двигательная активность пациента, препятствующая проведению измерений


нефатальная ошибка

90
Неисправно АЦП



фатальная ошибка

90
Неисправно ЦАП



фатальная ошибка

90
Неисправна аналоговая часть

Начальное смешение за пределами 5-15 мм.рт.ст.

фатальная ошибка

91
Монитор после замены батарей не был запрограммирован


нефатальная ошибка

92
Слишком большое время измерения (более 2 мин)


нефатальная ошибка

93
Аккумуляторы полностью разряжены


нефатальная ошибка

94
Не удалось определить диастолу

Press_m.asm
нефатальная ошибка

95
Не удалось определить систолу

Press_m.asm
нефатальная ошибка


Не удалось определить систолу и среднее давление

Press_m.asm
нефатальная ошибка

85
Систолическое АД пациента больше 270 мм рт. ст.

Press_m.asm
нефатальная ошибка

96
Не удалось определить частоту пульса
Не ясен критерий

нефатальная ошибка

97
Артефакты движения или аритмия
Не ясен критерий

нефатальная ошибка

98
Вся оперативная память монитора заполнена результатами. Количество измерений превысило верхнюю границу для данного типа регистратора (для BP005 - 255)


нефатальная ошибка

> 99
Измерение прервано из-за нештатного режима работы пневматики


нефатальная ошибка

59
Неплотная манжета


нефатальная ошибка

60...79
Аппаратный сбой




Сбойная ситуация - временное выключение питания прибора во время мониторирования. Если нет резервного питания для часов реального времени, то после восстановления питания выполняются следующие действия:
* в таблицу результатов измерений помещается запись о событии (фиктивном измерении) с кодом ошибки <40>
* в таблицу начальных адресов процессов измерений помещается запись о фиктивном процессе измерения длиной 0
* показания часов устанавливаются на (время последнего измерения + 1/2 интервала между измерениями для данного периода)
* очередное измерение производится после включения питания с задержкой, равной 1/2 интервала между измерениями для данного периода

32. Звуковые сигналы

Монитор подает звуковые сигналы при наступлении следующих событий:

N п.п.
Событие
Гудки
Условие

При включении питания, если код самодиагностики 00
Один длинный
Всегда

При включении питания, если код самодиагностики отличается от 00
Один длинный
Всегда

Окончание программирования от компьютера
Один длинный
Всегда

Начало измерения
Один длинный
Если звуковой сигнал разрешен и только в дневное время

Удачное завершение измерения (код ошибки 00)
Один длинный
-//-

Неудачное завершение измерения (код ошибки отличается от 00)
Один длинный
-//-

Система не стравливает воздух при открытии клапана (ошибка 99)
Короткие гудки непрерывно, вплоть до устранения сбоя или отключения питания
Всегда

33. Тестовый режим работы регистратора

Этот режим предназначен, в основном, для испытаний и поверки прибора.
Прибор переходит в поверочный режим:
если в момент включения питания была нажата кнопка СТАРТ/СТОП.
при приеме служебной команды с номером подфункции 0808h

При последующих нажатиях на кнопку прибор должен производить измерение статического избыточного давления воздуха, приложенного ко входному пневморазъему.
Вариант: непрерывно отображать на индикаторе текущее значение давления

34. Требования безопасности
Требования, изложенные в данном разделе могут частично дублировать другие разделы описания прибора. Они сведены вместе, поскольку носят обязательный характер.

Требования безопасности основываются на следующих стандартах:
ГОСТ 28703-90 (п.2.5-2.11 - технические требования, п.3.13-3.20 - методы испытаний);
IEC 60601-2-30

В приборе должны быть предусмотрены защитные устройства, независимые от рабочей системы регулирования давления в манжете, предотвращающие следующие опасные ситуации.
Превышение давления в манжете свыше уровня максимального рабочего давления
Превышение времени, в течение которого давление в манжете может превышать 15 мм рт. ст.
Слишком короткие перерывы между измерениями

В состав системы аварийного сброса давления должен входить отдельный аварийный клапан, к которому предъявляются следующие требования:
перевод в открытое или закрытое состояние производится короткими импульсами тока
последнее состояние клапана (открытое или закрытое) сохраняется при отключении питания.
При включении питания монитора, как составная часть теста самодиагностики, должно проверяться состояние этого клапана.
Если клапан закрыт (это означает, что до этого в работе прибора не были обнаружены опасные сбои) производится открытие и закрытие клапана с целью проверки его работоспособности.
Если клапан открыт, то на индикатор выводится код самодиагностики, и в рабочий режим прибор не переводится.
35. Защита от превышения давления в манжете свыше уровня максимального рабочего давления
Монитор должен иметь 2 диапазона по максимальному рабочему давлению:
диапазон 1 (детский) - 200 мм рт. ст.
диапазон 2 (взрослый) - 300 мм рт. ст

Диапазон устанавливается программно. Правильность установки диапазона контролируется по совместимости значений полей параметров программирования прибора "Возраст" и "Взрослый/Детский" (если возраст  < 14, то режим должен быть "Детский"). Если параметры программирования несовместимы, , то возвращается код результата 11h,11h,AAh,AAh (команда не может быть выполнена).

Давление в манжете должно быть сброшено до значения ниже 15 мм рт. ст. за время не более 30 с при выполнении одного из следующих условий:
или немедленно, если давление превысило максимальное рабочее более чем на 10%
или в течение 15 с после того, как был превышен уровень максимального рабочего давления

Примечание: в последнем случае пауза предотвращает сброс давления при его случайных кратковременных выбросах.

При сбросе давления выполняются следующие действия:
снимается питание с компрессора
открывается (обесточивается) рабочий клапан
открывается (переводится в постоянно открытое состояние) аварийный клапан
подается звуковой сигнал в виде непрерывной последовательности коротких гудков
на индикаторе монитора отображается код ошибки

36. Защита от превышения времени, в течение которого давление в манжете может превышать 15 мм рт. ст
В любом режиме работы монитора время, в течение которого давление в манжете может превышать 15 мм рт. ст., должно быть не более 120 с. При превышении этого времени давление в манжете должно быть сброшено до значения ниже 15 мм рт. ст. за время не более 30 с.
При сбросе давления выполняются те же действия, что и при превышении максимального рабочего давления:
снимается питание с компрессора
открывается (обесточивается) рабочий клапан
открывается (переводится в постоянно открытое состояние) аварийный клапан
подается звуковой сигнал в виде непрерывной последовательности коротких гудков
на индикаторе монитора отображается код ошибки

37. Защита от слишком коротких перерывов между измерениями
Перерыв после каждого цикла измерения, при котором давление в манжете превышает 15 мм рт. ст., должен составлять не менее 30 с.
Для обеспечения этого перерыва в мониторе предусматривается устройство, которое блокирует подачу питания на компрессор и на рабочий клапан (т.е. его открытие) в течение 30 с после завершения очередного цикла измерения. Это устройство должно обнаруживать попытки со стороны рабочей системы регулирования давления подать питание на компрессор и рабочий клапан. В случае обнаружения такой попытки выполняются следующие действия:
открывается (переводится в постоянно открытое состояние) аварийный клапан
подается звуковой сигнал в виде непрерывной последовательности коротких гудков
на индикаторе монитора отображается код ошибки

4



15



