
	Протокол обмена между ЭКГ кабелем и BPlab.

Несмотря на обстоятельства.  
  1. Вопросы требующие решения. (Изменения в программе BPlab)
	1.Изменение в структуре организации прерываний BPlab
	  (организация фонового режима).						Костенко
	2.Организация PIP-a для сигналов давления и перемещения 		Костенко
	  задачи обработки этих сигналов из обработки прерывания 		Зыков
	  таймера в фоновый режим.
	3.Организация PIP-a для ЭКГ сигналов - по 4-32-а слова на канал	Костенко
	4.Организация PIP-ов для записи во Flash 
  (перемещение в фоновый режим).						Костенко
	5.Изменение в протоколе UART(см. ниже)					Костенко

  2. Организации протокола.
	Скорость 115.2кбит/сек, 8 бит данных, проверки четности - нет,
	 2-а стоп бита.
	BPlab посылает команды, ЭКГ кабель выполняет их и посылает ответ, но
	при включении питания , наоборот, обмен начинает кабель. 
	При отключенном кабеле(не важно каком) на входе BPlab уровень "high"
	на входе RX процессора уровень "0" - Пауза. При подключении кабеля 
	(появления у кабеля питания) уровень на входе BPlab "low" - на входе 
	RX процессора уровень "1", при этом ЭКГ кабель раз в 0.1*сек начинает
	посылать символ "А"(0x41), после стандартного ответа "0x41,0x00", 
	ЭКГ кабель посылает команду ( ______________ ) переход UART BPlab 
	в режим ЭКГ. BPlab должен начать программирование кабеля. Если 
	программирование не началось в течении 1 сек - кабель ЭКГ 
	передергивает (1 сек) входной уровень BPlab и все сначала.
	Далее команды посылает BPlab. При отсутствии команд в течении более 
	чем 5 сек., кабель ЭКГ передергивает (1 сек) входной уровень BPlab 
	и все сначала.
	При отсутствии ответа кабеля на любую из команд: 
	либо команда принята с ошибкой,
	либо если кабель не отвечает более чем на 8-мь команд подряд - 
	кабель отсутствует - неисправен.)

	2.1. Программирование ЭКГ кабеля. 			(0x96 - 10010110)
	     (производится при инициализации системы и далее в любой момент времени)
		1. Количество каналов, Частота дискретизации.(1-й байт)
		   1-й байт - 0x69 - 01101001
		   2-й байт - lowest 4 bits - channels number
				( 1-one, 2-two, 3-three channels ),
			        highest 4 bits - samples frequncy
				( 1-100 Hz, 2-200 Hz, 3-300Hz, 4-400Hz ).
		   3-й байт - reserved - 0x00;
		   4-й байт - word_CRC16 (high byte);
		   5-й байт - word_CRC16 (low byte);

	2.2. Команда синхронизации - для ФАПЧ. 		(0x5A - 01011010)
		В ответ посылается величина рассогласования фаз 
		частоты дискретизации и времени приема команды (от-128до+127)
		Это для контроля и статистики.
		Команда должна посылаться из таймерного прерывания в самом начале.
		Первая команда после включения питания синхронизирует частоту 
		дискретизации. Даже при отсутствии ответа следующая 
		"команда синхронизации" посылается только при следующем 
		таймером прерывании.
	2.3. Команда старта выдачи пакета данных.		(0xF0 - 11110000)
		Если данные не готовы, в байте "Кол-во отчетов в FIFO-шке" - "0".
		Если SampleNumberToFIFO = 1, то передается значения соответствующие 
		предыдущему отсчету. Первый раз передаются все нули. 
		Время подготовки отсчета (по 3-м канала) около 1 мсек.
		Формат пакета данных:
		byte0 = SampleNumberToFIFO;
		byte1 = word_1_channel (high byte);
		byte2 = word_1_channel (low byte);
		byte3 = word_2_channel (high byte) - when ChannelNumber > 1;
		byte4 = word_2_channel (low byte)  - when ChannelNumber > 1; 
		byte5 = word_3_channel (high byte) - when ChannelNumber > 2; 
		byte6 = word_3_channel (low byte)  - when ChannelNumber > 2; 
		....;
		byte(ChannelNumber*2+2) = word_CRC16 (high byte);
		byte(ChannelNumber*2+3) = word_CRC16 (low byte);		
	2.4. Команда повтора последнего пакета 		(0x3C - 00111100)
	2.5. Команда проверки канала связи			(0x69 - 01101001)
		В ответ посылается код команды.
		Если ответа нет в течении 1 мсек., BPlab повторяет команду.
Если ответа нет два раза подряд - кабель неисправен.

	Список команд.
	(0xF0 - 00001111)	Резерв
	(0xF0 - 11110000)	Старт выдачи пакета данных
	(0x3C - 00111100)	Повтор последнего пакета данных
	(0xC3 - 11000011)	Резерв
	(0x5A - 01011010)	Синхронизация - для ФАПЧ
	(0xA5 - 10100101)	Резерв
	(0x96 - 10010110)	Программирование ЭКГ кабеля
	(0x69 - 01101001)	Проверка канала связи



